---
- name: Pre-install stuff
  hosts: all
  tasks:
    - name: Install python 2 if not there
      raw: |
        test -e /usr/bin/python || \
        (apt -y update && apt install -y  python-minimal)
      register: output
      changed_when: output.stdout|trim() != ""
    - name: Install sudo if not there
      raw: |
        test -e /usr/bin/sudo || apt install -y sudo
      register: output
      changed_when: output.stdout|trim() != ""
    - name: Install "postgresql" package
      apt:
        name: postgresql-9.5
        state: present
    - name: Install "python-psycopg2" package
      apt:
        name: python-psycopg2
        state: present
  gather_facts: False
  become: True

- name: Test Superset role
  hosts: all
  vars:
    # superset stuff
    superset_version: 0.24
    superset_python_executable: "python3.6"
    superset_secret_key: hunter2
    superset_languages:
      - key: en
        flag: us
        name: English
    superset_username: johndoe
    superset_firstname: John
    superset_lastname: Doe
    superset_email: johndoe@example.com
    superset_pass: hunter2
    superset_flask_secret_key: hunter2
    superset_auth_type: AUTH_DB
    superset_oauth_providers:
      - name: ona-platform
        icon: fa-rebel
        token_key: access_token
        consumer_key: os.environ.get('ONA_KEY')
        consumer_secret: os.environ.get('ONA_SECRET')
        base_url: http://api.ona.io/o/
        access_token_url: http://api.ona.io/o/token
        authorize_url: http://api.ona.io/o/authorize
    superset_service_env_vars:
      ONA_KEY: "onauser"
      ONA_SECRET: "hunter2"
    superset_postgres_db_name: superset
    superset_postgres_db_user: superset
    superset_postgres_db_pass: hunter2
    superset_postgres_login_user: "postgres"
    superset_postgres_login_password: "hunter2"
    superset_white_label: True
    superset_white_label_use_base64: True
    superset_favicon_base64: |
      iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z/C/HgAGgwJ/lK3Q6wAAAABJRU5ErkJggg==
    superset_logo_base64: |
      iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z/C/HgAGgwJ/lK3Q6wAAAABJRU5ErkJggg==
    superset_2x_logo_base64: | 
      iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z/C/HgAGgwJ/lK3Q6wAAAABJRU5ErkJggg==
  gather_facts: True
  become: True
  roles:
    - role: ../..